<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Snow game</title>
	<script type="text/javascript" src="js/lib/external/crafty-min.js"></script>
	
</head>
<body>
	<canvas width="600" height="100" id="dashboard" style="position: absolute; left: 0px; top: 0px; z-index: 1000000;"></canvas>
	<audio style="display:none;" id="panther_engine">
	  Your browser does not support the <code>audio</code> element.
	  <source src="sounds/panther_engine.wav" type="audio/wav">
	</audio>
	<audio style="display:none;" id="keys">
	  Your browser does not support the <code>audio</code> element.
	  <source src="sounds/keys.mp3" type="audio/wav">
	</audio>
	<script type="text/javascript">

		var Settings = {};
	    	Settings.poligon = 64;
	    	Settings.grenades = [];

	    var mapWidth = 3500,
	    	mapHeight = 2500;

	    var canvas = document.getElementById("dashboard");
		var ctx = canvas.getContext('2d');

		var pic = new Image();
		pic.src = 'images/grenade.png';
		pic.onload = function(){

			var offsetX = 480;
			for(var n = 0; n <= 6 * 20; n += 20){
				ctx.drawImage(pic, offsetX, 25);
				offsetX += 20;
			}
		}

		window.onload = function(){

			Crafty.init(600, 600);
			Crafty.pixelart(true);

	    	Crafty.sprite(32, 32, "images/player_sprite.png", {
				'solder': [0, 0]
			});

			Crafty.sprite(32, 36, "images/solder.png", {
				'enemy': [2, 0]
			});

			Crafty.sprite(64, 64, "images/trees.png", {
				'tree': [0, 0]
			});

			Crafty.sprite(32, 32, "images/stump.png", {
				'stump': [0, 0]
			});

			Crafty.sprite(85, 160, "images/E-100.png",{
				'tank1': [0, 0]
			});

			Crafty.sprite("images/fence.png",{
				'fence10': [200, 310, 20, 110],
				'fence11': [200, 270, 100, 30]
			});

			Crafty.sprite(85, 150, "images/tower.png",{
				'tower': [0, 0]
			});

			Crafty.sprite(200, 80, "images/jeep.png",{
				'jeep': [0, 0]
			});

			Crafty.sprite(30, 30, "images/grenade.png",{
				'grenade': [0, 0]
			});

			Crafty.sprite(64, 64, "images/explode.png",{
				'grenade_explode': [0, 0]
			});

			Crafty.sprite(100, 100, "images/particle_sprites.png",{
				'particle_explosion': [0, 0]
			});

			Crafty.sprite(24, 24, "images/tank_key.png",{
				'tank_key': [0, 0]
			});

			Crafty.sprite(64, 64, "images/blood.png",{
				'blood': [0, 0]
			});

			Crafty.sprite(62, 37, "images/broken_tree.png",{
				'broken_tree': [0, 0]
			});

			Crafty.sprite(32, 32, "images/bullets.png",{
				'shell': [0, 4]
			});

			Crafty.sprite(40, 40, "images/particle_large.png",{
				'particle_large': [0, 0]
			});

			Crafty.sprite(64, 64, "images/explosions.png",{
				'tank_explosion': [0, 3]
			});

			Crafty.audio.add("basic", "sounds/wargame.mp3");
			Crafty.audio.add("walk", "sounds/walk.wav");
			Crafty.audio.add("hole", "sounds/hole.ogg");
			Crafty.audio.add("explode", "sounds/explode.mp3");
			Crafty.audio.add("krik", "sounds/krik.mp3");
			Crafty.audio.add("wood", "sounds/wood.mp3");
			Crafty.audio.add("shoot_tank", "sounds/shoot_tank.mp3");

			Crafty.audio.maxChannels = 20;
			Crafty.audio.setChannels(20);

	    	Crafty.scene("main");
			
		}

		var _drawLevelOne = function(){
			
			Crafty.background("#000");
		    //Load a background map
		    var worldBkg = Crafty.e("2D, DOM, Image");      
		    worldBkg.attr({  w: (mapWidth + 100), h: (mapHeight + 100), x: 0, y: 0  })
		    worldBkg.image("images/show_bkg.jpg", "repeat");   

			solder = Crafty.e("Solder").attr({
				x: 15,
				y: 15
			});
			
			for(var i = 0; i < 300; i += 1){

				var treeX = Math.round(Math.random() * (mapWidth - 350));
				var treeY = Math.round(Math.random() * mapHeight);

				Crafty.e("2D, DOM, Sprite, tree").attr({
					x: treeX + 30,
					y: treeY + 30
				}).sprite(3, 1);

				var treeX = Math.round(Math.random() * (mapWidth - 350));
				var treeY = Math.round(Math.random() * mapHeight);

				Crafty.e("2D, DOM, Sprite, tree").attr({
					x: treeX + 30,
					y: treeY + 30
				}).sprite(4, 1);
			}
			

			//Draw stumps
			for(var i = 0; i < 50; i += 1){
				var sX = Math.round(Math.random() * (mapWidth - 350));
				var sY = Math.round(Math.random() * mapHeight);

				Crafty.e("Stump").attr({
					x: sX + 30,
					y: sY + 30
				});
			}

			//Draw tank
			Crafty.e("Tank1").attr({
				x: mapWidth - 200,
				y: 340
			});


			//Draw fence
			var fenceY = 0;
			for(var n = 0; n < 3; n += 1){
				Crafty.e("2D, DOM, Sprite, fence10").attr({
					x: mapWidth - 250,
					y: fenceY
				});
				fenceY += 95;
			}

			Crafty.e("2D, DOM, Sprite, fence11").attr({
				x: mapWidth - 250,
				y: fenceY
			});

			Crafty.e("2D, DOM, Sprite, fence11").attr({
				x: mapWidth - 155,
				y: fenceY
			});

			fenceY += 30;
			for(var n = 0; n < 2; n += 1){
				Crafty.e("2D, DOM, Sprite, fence10").attr({
					x: mapWidth - 75,
					y: fenceY
				});
				fenceY += 95;
			}

			Crafty.e("2D, DOM, Sprite, fence11").attr({
				x: mapWidth - 155,
				y: fenceY
			});

			Crafty.e("2D, DOM, Sprite, fence11").attr({
				x: mapWidth - 250,
				y: fenceY
			});

			fenceY += 30;
			for(var n = 0; n < 22; n += 1){
				Crafty.e("2D, DOM, Sprite, fence10").attr({
					x: mapWidth - 250,
					y: fenceY
				});
				fenceY += 95;
			}

			//Draw tower
			Crafty.e("Tower").attr({
				x: mapWidth - 200,
				y: 600
			});

			Crafty.e("Tower").attr({
				x: mapWidth - 200,
				y: 1800
			});

			//Draw Jeep
			var jeepY = 800;
			for(var n = 0; n < 6; n += 1){

				offset = Math.random() * 50;
				Crafty.e("Jeep").attr({
					x: mapWidth - 160 - offset,
					y: jeepY
				});

				jeepY += 90;
			}

			var jeepY = 1900;
			for(var n = 0; n < 6; n += 1){

				offset = Math.random() * 50;
				Crafty.e("Jeep").attr({
					x: mapWidth - 160 - offset,
					y: jeepY
				});

				jeepY += 90;
			}

			Crafty.e("Enemy").attr({x: mapWidth - 400, y: mapHeight - 250, _hasKey: false});
			Crafty.e("Enemy").attr({x: mapWidth - 350, y: mapHeight - 850, _hasKey: true});
			Crafty.e("Enemy").attr({x: mapWidth - 450, y: mapHeight - 1350, _hasKey: false});
			Crafty.e("Enemy").attr({x: mapWidth - 450, y: mapHeight - 1650, _hasKey: false});

			Crafty.audio.play("basic", -1, 0.5);
		}

		var solder = null;
		Crafty.scene("main", function()
		{
		    _drawLevelOne();
		});

		Crafty.c("Stump", {
			init: function(){
				this.requires("2D, DOM, Sprite, stump");

				this.attr({
					x: 0,
					y: 0
				});
			}
		});

		Crafty.c("Jeep", {
			init: function(){
				this.requires("2D, DOM, Sprite, jeep");

				this.attr({
					x: 0,
					y: 0
				});
			}
		});

		Crafty.c("Tower", {
			init: function(){
				this.requires("2D, DOM, Sprite, tower");

				this.attr({
					x: 0,
					y: 0
				});
			}
		});

		Crafty.c("Tank1", {

			init: function(){
				this.requires("2D, DOM, tank1");
				this.requires("Fourway");
				this.requires("Keyboard");
				this.requires("Tween");
				this.requires("Collision");

				this.bind("EnterFrame", function(){
					if(this.x + 168 > mapWidth){
						Crafty.pause();

					}
				});
			}

		});

		Crafty.c("Particle_large", {

			init: function(){
				this.requires("2D");
  				this.requires("DOM");
  				this.requires("particle_large");
				this.requires("SpriteAnimation");

				this.reel("particle_large_explotion", 400, 0, 0, 8);

			}

		});

		Crafty.c("Tank_explosion", {

			init: function(){
				this.requires("2D");
  				this.requires("DOM");
  				this.requires("tank_explosion");
				this.requires("SpriteAnimation");

				this.reel("tank_explosion", 400, 0, 3, 17);
				this.reel("tank_explosion2", 400, 0, 4, 17);

			}

		});

		Crafty.c("Bullet", {

			dirX: 0,
			dirY: 0,
			offsetX: 0,
			offsetY: 0,

			init: function(){

				this.requires("2D");
  				this.requires("DOM");
  				this.requires("Fourway");
  				this.requires("shell");
  				
  				this.requires("Collision"); 
  				this.collision();
  				this.fourway(1);

  				this.onHit("tree", function(e){
  					_tree = e[0].obj;
  					this._explosionObject(_tree);					
  				});

  				this.onHit("Jeep", function(e){
  					_jeep = e[0].obj;
  					this._explosionObject(_jeep);					
  				});

  				this.onHit("Tower", function(e){
  					_tower = e[0].obj;
  					this._explosionObject(_tower);					
  				});

  				this.onHit("enemy", function(e){
  					_enemy = e[0].obj;
  					this._explosionObject(_enemy);					
  				});

  				this.onHit("fence10", function(e){
  					_f = e[0].obj;
  					this._explosionObject(_f);					
  				});

  				this.onHit("fence11", function(e){
  					_f = e[0].obj;
  					this._explosionObject(_f);					
  				});

  			},

  			_explosionObject: function(_tree){
  				var eX = _tree.x;
  				var eY = _tree.y;

  				Crafty.audio.play("explode", 1);
  				setTimeout(function(){
  					Crafty.audio.stop("explode");
  				}, 1000);

  				_tree.destroy();
  				this.destroy();

				Crafty.e("Tank_explosion").attr({
					x: eX,
					y: eY
				}).animate("tank_explosion", 1);

				setTimeout(function(){
					Crafty.e("Tank_explosion").attr({
						x: eX,
						y: eY
					}).animate("tank_explosion2", 1);

					Crafty.e("2D, DOM, particle_explosion").attr({
						x: eX,
						y: eY
					});
				}, 400);
  			},

			_bulletAnimated: function(){

				if(this.rotation == -180){
					this.offsetX = 40;
					this.offsetY = 30;
					this.dirX = 5;
					this.dirY = 0;
				}

				if(this.rotation == -90){
					this.dirX = 0;
					this.dirY = 5;
				}

				if(this.rotation == 0){
					this.offsetX = 20;
					this.offsetY = 10;
					this.dirX = -5;
					this.dirY = 0;
				}

				if(this.rotation == -270){
					this.offsetX = 32;
					this.offsetY = 0;
					this.dirX = 0;
					this.dirY = -5;
				}

				Crafty.e("Particle_large").attr({
					x: this.x - this.offsetX,
					y: this.y - this.offsetY
				}).animate("particle_large_explotion", 1);

				var kclass = this;
				setTimeout(function(){
					kclass._movement.x = kclass.dirX;
					kclass._movement.y = kclass.dirY;
				}, 0);				
			}

		})

		Crafty.c("Unit", {

			init: function(){

				this.requires("2D");
  				this.requires("DOM");

  				this.requires("Fourway");
  				this.requires("Collision"); 
  				this.collision();

  				this.fourway(1);
	  	  		
  				this.onHit("solder", function(e) {
  					var that = this;
				   	this.collisionWithObject(e, that);
				});

				this.onHit("enemy", function(e) {
  					var that = this;
				   	this.collisionWithObject(e, that);
				});

				this.onHit("stump", function(e) {
  					var that = this;
				   	this.collisionWithObject(e, that);
				});

  				this.onHit("tree", function(e) {
  					var that = this;
				   	this.collisionWithObject(e, that);
				});

  				this.onHit("tank1", function(e) {
  					var that = this;
				   	this.collisionWithObject(e, that);
				});

				this.onHit("fence10", function(e) {
  					var that = this;
				   	this.collisionWithObject(e, that);
				});

				this.onHit("fence11", function(e) {
  					var that = this;
				   	this.collisionWithObject(e, that);
				});

	  	  		this.bind("Moved", function(e) {
				   if(this.x < e.x) {
				   	if(!this.isPlaying("walk_left"))
				     	this.animate("walk_left", 1);
				   }
				   if(this.x > e.x) {
				    if(!this.isPlaying("walk_right"))
				     	this.animate("walk_right", 1);
				   }
				   if(this.y < e.y) {
				    if(!this.isPlaying("walk_up"))
				    	this.animate("walk_up", 1);
				   }
				   if(this.y > e.y) {
				   	if(!this.isPlaying("walk_down"))
				    	this.animate("walk_down", 1);
				   }
				});
			},

			collisionWithObject: function(e, that){

			   var object = e[0].obj;
			   // left
			   if (object.x > that.x && (that.x + Settings.poligon) > object.x) {
			    that.x -= that._speed.x;
			    that.y -= that._speed.y;
			   }
			   // right
			   if (object.x < that.x && that.x < (object.x + Settings.poligon)) {
			    that.x += that._speed.x;
			    that.y -= that._speed.y;
			   }
			   // top
			   if (object.y < that.y && (that.y + Settings.poligon) > object.y) {
			    that.y += that._speed.y;
			    //that.x -= that._speed.x;
			   }
			   // bottom
			   if (object.y > that.y && that.y < (object.y + Settings.poligon)) {
			    that.y -= that._speed.y;
			    //that.x -= that._speed.x;
			   }

			   if(that.has("Enemy")){
			   		this._enemySpeed = -this._enemySpeed;
			   }

			   if(that.has("Solder")){
			   		if(object.has("Tank1")){
			   			var _tank = object;

			   			var tankId = _tank.getId();
			   			document.getElementById('ent' + tankId).style.zIndex = '1000000';

						if(this._hasKey){

							var _tankWidth = 85;
							var _tankHeight = 160;

							_tank.attach(this);
							this.disableControls = true;

							Crafty.audio.stop("walk");
							this.unbind("KeyDown");
							this.unbind("KeyUp");

							this.visible = false;

							_tank.collision();
							_tank.fourway(1);

							_tank.bind("Moved",function(e){

								var panther_engine = document.getElementById('panther_engine');
								panther_engine.volume = 0.1;
								panther_engine.play();

								if(_tank.x <= 0)
									_tank.x += 1;

								if(_tank.y <= 0)
									_tank.y += 1;

								if(_tank.y >= mapHeight - 50)
									_tank.y -= 1;

								Crafty.viewport.follow(_tank, 0, 0);
							});

							_tank.origin("center center");

							_tank.bind("KeyDown", function(e){
								
								var panther_engine = document.getElementById('panther_engine');
								panther_engine.volume = 0.1;
								panther_engine.play();

								var rot = _tank.rotation;
								if(e.key == Crafty.keys.LEFT_ARROW && rot != 90){
									_tank.tween({rotation: rot + 10}, 10);
								}

								if(e.key == Crafty.keys.RIGHT_ARROW && rot != -90){
									_tank.tween({rotation: rot - 10}, 10);
								}

								if(e.key == Crafty.keys.DOWN_ARROW && rot != 0){
									_tank.tween({rotation: rot + 10}, 10);
								}

								if(e.key == Crafty.keys.UP_ARROW && rot != -180){
									_tank.tween({rotation: rot - 10}, 10);
								}

								
			  					if(e.key == Crafty.keys.LEFT_ARROW)
			  						keyMap.LEFT = 1;
			  					if(e.key == Crafty.keys.RIGHT_ARROW)
			  						keyMap.RIGHT = 1;
			  					if(e.key == Crafty.keys.UP_ARROW)
			  						keyMap.UP = 1;
			  					if(e.key == Crafty.keys.DOWN_ARROW)
			  						keyMap.DOWN = 1;
				  				
				  				_tank.bind("EnterFrame", function(){
				  					if(!keyMap.LEFT && !keyMap.RIGHT && !keyMap.UP && !keyMap.DOWN)
				  						panther_engine.pause();				  						
				  				});

								if(e.key == Crafty.keys.SPACE){
									
									if(rot == 90 || rot == -90 || rot == 0 || rot == -180){
										
										var _tankX = _tank.x;
										var _tankY = _tank.y;

										if(rot == -90){
											_tankX += 150;
											_tankY += 98;
										}

										if(rot == 0){
											_tankX += 20;
											_tankY += 168;
										}

										if(rot == -180){
											_tankX += 62;
											_tankY -= 20;
										}

										if(rot == 90){
											_tankX -= 40;
											_tankY += 62;
										}
										
										Crafty.audio.play("shoot_tank", 1);
										setTimeout(function(){
											Crafty.audio.stop("shoot_tank");

										}, 900);

										var _bullet = Crafty.e("Bullet").attr({
											x: _tankX,
											y: _tankY,
											rotation: rot - 90
										});

										_bullet._bulletAnimated();
									}
								}

							});

							_tank.bind("KeyUp", function(e){
			  					if(e.key == Crafty.keys.LEFT_ARROW)
			  						keyMap.LEFT = 0;
			  					if(e.key == Crafty.keys.RIGHT_ARROW)
			  						keyMap.RIGHT = 0;
			  					if(e.key == Crafty.keys.UP_ARROW)
			  						keyMap.UP = 0;
			  					if(e.key == Crafty.keys.DOWN_ARROW)
			  						keyMap.DOWN = 0;
				  			});


							_tank.onHit("enemy", function(e){
								var _enemy = e[0].obj;
								var _bloodX = _enemy.x;
								var _bloodY = _enemy.y;

								Crafty.audio.play("krik");
								
								if(_enemy){

									_enemy.destroy();
									Crafty.e("2D, DOM, blood").attr({
										x: _bloodX,
										y: _bloodY
									});
									setTimeout(function(){
										Crafty.audio.stop("krik");
									}, 1000);

								}
								
							});

							_tank.onHit("tree", function(e){

								var _tree = e[0].obj;
								if((_tank.x + Math.round(_tankHeight/2)) > _tree.x){

										Crafty.audio.play("wood", 1);
										var _treeX = _tree.x;
										var _treeY = _tree.y;
										_tree.destroy();	

										Crafty.e("2D, DOM, broken_tree").attr({
											x: _treeX,
											y: _treeY + 15
										});
								}

							});


							_tank.onHit("fence10", function(e){
								_tank.x -= 1;
							});

							_tank.onHit("Jeep", function(e){
								_tank.x -= 1;
							});

							_tank.onHit("Tower", function(e){
								_tank.x -= 1;
							});

							_tank.onHit("fence11", function(e){
								var _fence = e[0].obj;
								if(_tank.y < _fence.y)
									_tank.y += 1;
								if(_fence.y < _tank.y)
									_tank.y -= 1;
							});


							
						}
			   		}
			   }

			}

		});

		var keyMap = {
			'LEFT': 0,
			'RIGHT': 0,
			'UP': 0,
			'DOWN': 0
		}

		Crafty.c("Solder", {

			_hasKey: false,
			_grenadeAmount: 6,
			_grenadeMax: 6,
			_directionX: 0,
			_directionY: 1,
			_grenadeSpeed: 2,
			_grenadeInterval: null,
			_explodeTimer: null,

			init: function(){

				var viewportWidth = Crafty.viewport.width;
				var viewportHeight = Crafty.viewport.height;

				this.requires("Unit");
  				this.requires('solder');
  				this.requires("SpriteAnimation");
  				this.requires("Keyboard");

  				this.bind("KeyDown", function(e){
  					if(e.key == Crafty.keys.LEFT_ARROW)
  						keyMap.LEFT = 1;
  					if(e.key == Crafty.keys.RIGHT_ARROW)
  						keyMap.RIGHT = 1;
  					if(e.key == Crafty.keys.UP_ARROW)
  						keyMap.UP = 1;
  					if(e.key == Crafty.keys.DOWN_ARROW)
  						keyMap.DOWN = 1;
  				});
  				this.bind("KeyUp", function(e){
  					if(e.key == Crafty.keys.LEFT_ARROW)
  						keyMap.LEFT = 0;
  					if(e.key == Crafty.keys.RIGHT_ARROW)
  						keyMap.RIGHT = 0;
  					if(e.key == Crafty.keys.UP_ARROW)
  						keyMap.UP = 0;
  					if(e.key == Crafty.keys.DOWN_ARROW)
  						keyMap.DOWN = 0;
  				});

  				this.bind("EnterFrame", function(){
  					if(!keyMap.LEFT && !keyMap.RIGHT && !keyMap.UP && !keyMap.DOWN)
  						Crafty.audio.stop("walk");
  				});

	  			this.attr({x: 0, y: 0});
	  			
	  			this.reel("walk_left", 500, 0, 1, 2);
	  			this.reel("walk_right", 500, 0, 2, 2);
	  			this.reel("walk_up", 500, 0, 3, 2);
	  			this.reel("walk_down", 500, 0, 0, 2);
				
				this.bind("Moved", function(e) {

					Crafty.audio.play("walk", 1, 1);
					if(this.x < 0)
						this.x += this._speed.x;

					if(this.y < 0)
						this.y += this._speed.y;

					if(this.x > mapWidth)
						this.x -= this._speed.x;

					if(this.y > mapHeight)
						this.y -= this._speed.y;

					Crafty.viewport.follow(this, 0, 0);

					this._directionX = this._movement.x;
					this._directionY = this._movement.y;
				});

				this.onHit("tank_key", function(e){
					
					var keys = document.getElementById("keys");
					keys.play();
					
					setTimeout(function(){
						keys.pause();
					}, 1000);
					
					var _key = e[0].obj;

					this._hasKey = true;
					_key.destroy();
					var pic = new Image();
					pic.src = 'images/tank_key.png';
					pic.onload = function(){
						var offsetX = 570;
						ctx.drawImage(pic, offsetX, 50);
					}

				});

				this.bind("KeyDown", function(e){
					if(e.key == Crafty.keys.SPACE && this._grenadeAmount){

						Crafty.audio.play("hole");
						var _offsetX = 480;
						var k = this._grenadeMax - this._grenadeAmount;

						_offsetX = _offsetX + k * 20;
						ctx.globalCompositeOperation = 'destination-over';
						ctx.clearRect(_offsetX, 25, 20, 22);
						this._grenadeAmount -= 1;
						
						var gr = Crafty.e("2D, DOM, Collision, grenade").attr({
							x: this.x,
							y: this.y
						});

						gr.collision();
						gr._alreadyHit = false;

						var kclass = this;
						this._grenadeInterval = setInterval(function(){
							kclass._animateGrenade(gr);
						}, this._grenadeSpeed);

						//Grenade Explode
						this._explodeTimer = setTimeout(function(){
							clearInterval(this._grenadeInterval);
							kclass._animateExplode(gr);
						}, 2000);
						
						gr.onHit("tree", function(e){
							var object = e[0].obj;

							clearTimeout(kclass._explodeTimer);
							clearInterval(kclass._grenadeInterval);

							kclass._animateExplode(gr, object);
						});

						gr.onHit("stump", function(e){
							var object = e[0].obj;

							clearTimeout(kclass._explodeTimer);
							clearInterval(kclass._grenadeInterval);

							kclass._animateExplode(gr, object);
						});

						gr.onHit("enemy", function(e){
							var _enemy = e[0].obj;

							clearTimeout(kclass._explodeTimer);
							clearInterval(kclass._grenadeInterval);

							kclass._animateExplode(gr, _enemy);
						});
					}
				});
			},

			_animateGrenade: function(grenade){

				if(grenade.x <= 0 || grenade.y <= 0 || grenade.x >= mapWidth || grenade.y >= mapHeight){
					clearInterval(this._grenadeInterval);
					clearTimeout(this._explodeTimer);

					grenade.destroy();
				}

				if(this._directionX == 1){
					var grenadeX = grenade.x + this._directionX;
					var grenadeY = grenade.y;
				}

				if(this._directionX == -1){
					var grenadeX = grenade.x + this._directionX;
					var grenadeY = grenade.y;
				}

				if(this._directionY == 1){
					var grenadeX = grenade.x;
					var grenadeY = grenade.y + this._directionY;
				}

				if(this._directionY == -1){
					var grenadeX = grenade.x;
					var grenadeY = grenade.y + this._directionY;
				}

				var _rot = grenade.rotation + 0.1;

				grenade.attr({
					x: grenadeX,
					y: grenadeY,
					rotation: _rot
				});


				
			},

			_animateExplode: function(grenade, object){

				var grenadeX = grenade.x;
				var grenadeY = grenade.y;
				grenade.destroy();

				Crafty.audio.play("explode");

				setTimeout(function(){
					Crafty.audio.stop("explode");
				}, 1500);

				if(object){
					var _objX = object.x;
					var _objY = object.y;

					Crafty.e("2D, DOM, particle_explosion").attr({
						x: _objX - 35,
						y: _objY - 10
					});

					if(object.has("Enemy")){
						var _hasKey = object._hasKey;
						if(_hasKey){
							Crafty.e("2D, DOM, tank_key").attr({
								x: _objX,
								y: _objY
							});
						}
					}

					object.destroy();					
				} else {
					Crafty.e("2D, DOM, particle_explosion").attr({
						x: grenadeX - 35,
						y: grenadeY - 20
					});
				}

				

				var explode = Crafty.e("2D, DOM, GrenadeExplode").attr({
					x: grenadeX,
					y: grenadeY
				});

				explode.animate("explode1", 1);
				setTimeout(function(){
					explode.animate("explode2", 1);
				}, 500);
				setTimeout(function(){
					explode.animate("explode3", 1);
				}, 1000);
				setTimeout(function(){
					explode.animate("explode4", 1);
				}, 1500);
				setTimeout(function(){
					explode.destroy();
				}, 2000);
				
				var solderId = solder.getId();
				document.getElementById('ent' + solderId).style.zIndex = '1000000';
			}


		});

		Crafty.c("GrenadeExplode", {

			init: function(){

				this.requires("2D");
				this.requires("DOM");
				this.requires("SpriteAnimation");
				this.requires("grenade_explode");

				this.reel("explode1", 500, 0, 0, 3);
				this.reel("explode2", 500, 0, 1, 3);
				this.reel("explode3", 500, 0, 2, 3);
				this.reel("explode4", 500, 0, 3, 4);
			}

		})

		Crafty.c('Enemy', {
		 
		 init: function() {

		  	this.requires("Unit");
		  	this.requires("SpriteAnimation");
		  	this.requires("enemy");
		  	this.requires("FourwayAI");

		  	this.attr({x: 0, y: 0, _hasKey: false});
		  
		  	this.reel("walk_left", 500, 2, 1, 4);
		  	this.reel("walk_right", 500, 2, 2, 4);
		  	this.reel("walk_up", 500, 2, 3, 4);
		  	this.reel("walk_down", 500, 2, 0, 4);
		  
		  	this.fourway_ai(1);

		  	this.bind("Moved", function(e) {
				if(this.x < 0)
					this.x += this._speed.x;

				if(this.y < 0)
					this.y += this._speed.y;

				if(this.x > mapWidth)
					this.x -= this._speed.x;

				if(this.y > mapHeight)
					this.y -= this._speed.y;

			});
		   	
		 },
		 
		 clear: function() {
		  	clearInterval(this.removeComponent('enemy')._interval);
		 }

		});

		Crafty.c('FourwayAI', {

		  _enemySpeed: 1,
		  _enemyDir: 1,
		  _interval: null,
		    
		  init: function() {

		  	this._movement= { x: 0, y: 0};
		  
		  	this.bind("EnterFrame",function() {
		   		
		   		if (this.disableControls) return;

		   		if(this.x <= 0 || this.y <= 0 || this.x >= mapWidth || this.y >= mapHeight)
					this._enemySpeed = -this._enemySpeed;	  
		  		
		  		step = this._enemySpeed;
			  	if (this._enemyDir == 1) {
			   		this._movement.x = step;
			    	this._movement.y = 0;
			  	} else {
			   		this._movement.x = 0;
			    	this._movement.y = step;
			  	}

		  	});


		  },
		 
		 fourway_ai: function(speed) {

		 	var that = this;
		  	this._interval = setInterval(function() {
		  		var line = [1,2];
		   		that._enemyDir = line[Math.round(Math.random() * 1)];
		  	}, 1000 * speed);

		 }

		});

	</script>
</body>
</html>